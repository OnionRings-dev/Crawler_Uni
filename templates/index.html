<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Domain Search Bot</title>
</head>
<body>
    <h1>Multi-Domain Search Bot</h1>
    
    <div>
        <h2>Search Form</h2>
        
        <form id="searchForm">
            <div>
                <label for="domainSelect">Select Domain:</label>
                <select id="domainSelect" required>
                    <option value="">Loading domains...</option>
                </select>
            </div>
            
            <div>
                <label for="queryInput">Your Question:</label>
                <input type="text" id="queryInput" placeholder="Es. Come faccio a iscrivermi?" required>
            </div>
            
            <button type="submit" id="searchButton">Search</button>
        </form>
    </div>
    
    <div id="statusContainer" style="display: none;">
        <h3>Status</h3>
        <p id="statusText"></p>
    </div>
    
    <div id="resultsContainer" style="display: none;">
        <h2>Results</h2>
        <div id="resultsContent"></div>
        <button onclick="clearSearch()">New Search</button>
    </div>

    <script>
        let currentRequestId = null;
        let statusCheckInterval = null;

        window.onload = function() {
            loadAvailableDomains();
            
            document.getElementById('searchForm').addEventListener('submit', function(e) {
                e.preventDefault();
                performSearch();
            });
        };

        function loadAvailableDomains() {
            fetch('/api/domains')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('domainSelect');
                select.innerHTML = '';
                
                if (data.domains && data.domains.length > 0) {
                    data.domains.forEach(domain => {
                        const option = document.createElement('option');
                        option.value = domain;
                        option.textContent = domain;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">No domains available</option>';
                }
            })
            .catch(error => {
                const select = document.getElementById('domainSelect');
                select.innerHTML = '<option value="">Error loading domains</option>';
            });
        }

        function performSearch() {
            const domain = document.getElementById('domainSelect').value;
            const query = document.getElementById('queryInput').value.trim();
            
            if (!domain) {
                showStatus('Please select a domain');
                return;
            }
            
            if (!query) {
                showStatus('Please enter a question');
                return;
            }

            document.getElementById('searchButton').disabled = true;
            document.getElementById('searchButton').textContent = 'Processing...';
            document.getElementById('resultsContainer').style.display = 'none';
            
            showStatus('Sending query to server...');

            fetch('/api/query', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    query: query,
                    domain: domain
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showStatus('Error: ' + data.error);
                    resetSearchButton();
                } else {
                    currentRequestId = data.request_id;
                    showStatus('Processing query...');
                    statusCheckInterval = setInterval(checkStatus, 1000);
                }
            })
            .catch(error => {
                showStatus('Connection error');
                resetSearchButton();
            });
        }

        function checkStatus() {
            fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'completed' && data.request_id === currentRequestId) {
                    clearInterval(statusCheckInterval);
                    
                    if (data.result && data.result.latex_content) {
                        showResults(data.result.latex_content, data.result.domain);
                        showStatus('Completed!');
                    } else {
                        showStatus('No results found');
                    }
                    
                    resetSearchButton();
                } else if (data.status === 'error') {
                    clearInterval(statusCheckInterval);
                    showStatus('Error during processing: ' + (data.error || 'Unknown error'));
                    resetSearchButton();
                } else if (data.status === 'processing') {
                    showStatus('Processing: ' + (data.message || 'Please wait...'));
                }
            })
            .catch(error => {
                clearInterval(statusCheckInterval);
                showStatus('Connection error');
                resetSearchButton();
            });
        }

        function showStatus(message) {
            document.getElementById('statusContainer').style.display = 'block';
            document.getElementById('statusText').textContent = message;
        }

        function showResults(latexContent, domain) {
            const resultsContent = document.getElementById('resultsContent');
            const resultsContainer = document.getElementById('resultsContainer');
            
            let html = '<h3>Domain: ' + domain + '</h3>';
            html += processLatexForDisplay(latexContent);
            
            resultsContent.innerHTML = html;
            resultsContainer.style.display = 'block';
        }

        function processLatexForDisplay(latex) {
            if (!latex) return '<p>Empty content</p>';
            
            let html = latex;
            
            html = html.replace(/\\documentclass\{[^}]+\}/g, '');
            html = html.replace(/\\usepackage\[[^\]]*\]\{[^}]+\}/g, '');
            html = html.replace(/\\usepackage\{[^}]+\}/g, '');
            html = html.replace(/\\begin\{document\}/g, '');
            html = html.replace(/\\end\{document\}/g, '');
            html = html.replace(/\\maketitle/g, '');
            html = html.replace(/\\title\{[^}]*\}/g, '');
            html = html.replace(/\\author\{[^}]*\}/g, '');
            html = html.replace(/\\date\{[^}]*\}/g, '');
            
            html = html.replace(/\\section\{([^}]+)\}/g, '<h2>$1</h2>');
            html = html.replace(/\\subsection\{([^}]+)\}/g, '<h3>$1</h3>');
            html = html.replace(/\\subsubsection\{([^}]+)\}/g, '<h4>$1</h4>');
            
            html = html.replace(/\\textbf\{([^}]+)\}/g, '<strong>$1</strong>');
            html = html.replace(/\\textit\{([^}]+)\}/g, '<em>$1</em>');
            html = html.replace(/\\emph\{([^}]+)\}/g, '<em>$1</em>');
            
            html = html.replace(/\\begin\{itemize\}/g, '<ul>');
            html = html.replace(/\\end\{itemize\}/g, '</ul>');
            html = html.replace(/\\begin\{enumerate\}/g, '<ol>');
            html = html.replace(/\\end\{enumerate\}/g, '</ol>');
            html = html.replace(/\\item\s*/g, '<li>');
            
            html = html.replace(/\\href\{([^}]+)\}\{([^}]+)\}/g, '<a href="$1" target="_blank">$2</a>');
            html = html.replace(/\\url\{([^}]+)\}/g, '<a href="$1" target="_blank">$1</a>');
            
            html = html.replace(/\\\\\s*/g, '<br>');
            html = html.replace(/\\par\s*/g, '</p><p>');
            html = html.replace(/\n\s*\n/g, '</p><p>');
            
            html = html.replace(/\s+/g, ' ').trim();
            if (html && !html.startsWith('<')) html = '<p>' + html + '</p>';
            html = html.replace(/<p>\s*<\/p>/g, '');
            
            return html || '<p>Error in conversion</p>';
        }

        function resetSearchButton() {
            document.getElementById('searchButton').disabled = false;
            document.getElementById('searchButton').textContent = 'Search';
        }

        function clearSearch() {
            document.getElementById('queryInput').value = '';
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('statusContainer').style.display = 'none';
            
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            
            resetSearchButton();
        }
    </script>
</body>
</html>
